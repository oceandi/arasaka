<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground - KAREL Network Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #2563eb;
            --accent-color: #3b82f6;
            --text-color: #f8fafc;
            --menu-bg: #0f172a;
            --content-bg: #1e293b;
            --card-bg: #334155;
            --border-color: #475569;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--content-bg);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background-color: var(--menu-bg);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .logo .subtitle {
            font-size: 12px;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .menu {
            flex: 1;
        }
        
        .menu ul {
            list-style: none;
        }
        
        .menu li {
            margin-bottom: 5px;
        }
        
        .menu a {
            display: flex;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .menu a:hover, .menu a.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        .menu a i {
            margin-right: 10px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .icon {
            font-size: 30px;
            margin-right: 15px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .stat-card.primary .icon {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--accent-color);
        }
        
        .stat-card.success .icon {
            background-color: rgba(34, 197, 94, 0.2);
            color: var(--success-color);
        }
        
        .stat-card .info {
            flex: 1;
        }
        
        .stat-card .info h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card .info p {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .module-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .module-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            position: relative;
        }
        
        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .module-icon {
            font-size: 48px;
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        
        .module-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .module-card p {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        
        .module-card small {
            font-size: 12px;
            color: #64748b;
        }

        .module-pin {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #64748b;
            transition: all 0.3s;
            opacity: 0.5;
        }

        .module-pin:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Sabitlenmiş durumu için */
        .module-pin.is-pinned {
            color: var(--accent-color);
            opacity: 1;
        }

        .module-pin.is-pinned i {
            filter: drop-shadow(0 0 5px var(--accent-color));
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: var(--content-bg);
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            max-height: 95vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close {
            color: var(--text-color);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--accent-color);
        }
        
        .form-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--content-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        .field-builder {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .field-item {
            background-color: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .field-item input, .field-item select {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--content-bg);
            color: var(--text-color);
        }
        
        .text-muted {
            color: #64748b;
            font-size: 12px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }

        .module-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .module-card {
            position: relative;
            padding-bottom: 60px; /* Butonlar için alan */
        }

        .module-actions {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="logo">
            <h1>KAREL</h1>
            <div class="subtitle">Playground</div>
        </div>
        <div class="menu">
            <ul>
                <li><a href="/browse"><i class="fas fa-arrow-left"></i> Ana Menüye Dön</a></li>
                <li><a href="#" class="active"><i class="fas fa-puzzle-piece"></i> Modüllerim</a></li>
                <li><a href="#" onclick="showCreateModule()"><i class="fas fa-plus"></i> Yeni Modül</a></li>
            </ul>
        </div>
    </div>
    
    <div class="content">
        <div class="header">
            <h2>Playground - Özel Modüller</h2>
        </div>
        
        <div class="dashboard">
            <div class="stat-card primary">
                <div class="icon"><i class="fas fa-puzzle-piece"></i></div>
                <div class="info">
                    <h3 id="moduleCount">0</h3>
                    <p>Toplam Modül</p>
                </div>
            </div>
            <div class="stat-card success">
                <div class="icon"><i class="fas fa-database"></i></div>
                <div class="info">
                    <h3 id="totalRecords">0</h3>
                    <p>Toplam Kayıt</p>
                </div>
            </div>
        </div>
        
        <div id="moduleList" class="module-list">
            <!-- Modüller buraya gelecek -->
        </div>
        
        <button class="btn btn-primary" onclick="showCreateModule()">
            <i class="fas fa-plus"></i> Yeni Modül Oluştur
        </button>
    </div>
</div>

<!-- Modül Oluşturma Modal -->
<div id="create-module-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Yeni Modül Oluştur</h2>
            <span class="close" onclick="closeModuleModal()">&times;</span>
        </div>
        
        <form id="createModuleForm">
            <div class="form-section">
                <h3>Modül Bilgileri</h3>
                <div class="form-group">
                    <label>Modül Adı (İngilizce, boşluksuz)</label>
                    <input type="text" id="moduleName" required pattern="[a-z_]+" 
                           placeholder="ornek_modul">
                </div>
                <div class="form-group">
                    <label>Görünen İsim</label>
                    <input type="text" id="moduleDisplayName" required 
                           placeholder="Örnek Modül">
                </div>
                <div class="form-group">
                    <label>İkon (Font Awesome)</label>
                    <select id="moduleIcon">
                        <option value="fas fa-database">Database</option>
                        <option value="fas fa-chart-bar">Chart</option>
                        <option value="fas fa-cog">Settings</option>
                        <option value="fas fa-file">File</option>
                        <option value="fas fa-users">Users</option>
                        <option value="fas fa-tasks">Tasks</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Açıklama</label>
                    <textarea id="moduleDescription" rows="3"></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Alanlar (Sütunlar)</h3>
                <div id="fieldList" class="field-builder">
                    <!-- Varsayılan alanlar -->
                    <div class="field-item" data-field="id">
                        <i class="fas fa-key"></i>
                        <input type="text" value="ID" disabled>
                        <select disabled>
                            <option>Otomatik</option>
                        </select>
                        <span class="text-muted">Sistem alanı</span>
                    </div>
                </div>
                
                <button type="button" class="btn btn-secondary" onclick="addField()">
                    <i class="fas fa-plus"></i> Alan Ekle
                </button>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Modül Oluştur</button>
                <button type="button" class="btn btn-secondary" onclick="closeModuleModal()">İptal</button>
            </div>
        </form>
    </div>
</div>

<script>
let modules = [];
let fieldCounter = 0;

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    loadModules();
});

// Modülleri yükle
async function loadModules() {
    const response = await fetch('/api/playground/modules');
    modules = await response.json();
    
    document.getElementById('moduleCount').textContent = modules.length;
    
    const moduleList = document.getElementById('moduleList');
    moduleList.innerHTML = '';
    
    modules.forEach(module => {
        const card = document.createElement('div');
        card.className = 'module-card';
        card.innerHTML = `
            <div class="module-pin ${module.is_pinned ? 'is-pinned' : ''}" 
                onclick="togglePin(${module.id}, event)" 
                title="${module.is_pinned ? 'Menüden kaldır' : 'Menüye sabitle'}">
                <i class="fas fa-thumbtack"></i>
            </div>
            <div class="module-icon">
                <i class="${module.icon || 'fas fa-puzzle-piece'}"></i>
            </div>
            <h3>${module.display_name}</h3>
            <p>${module.description || 'Açıklama yok'}</p>
            <div class="mt-3">
                <small>Oluşturulma: ${new Date(module.created_at).toLocaleDateString('tr-TR')}</small>
            </div>
            <div class="module-actions" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/playground/module/${module.name}'">
                    <i class="fas fa-eye"></i> Görüntüle
                </button>
                <button class="btn btn-secondary btn-sm" onclick="editModule(${module.id})">
                    <i class="fas fa-edit"></i> Düzenle
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteModule(${module.id}, '${module.name}')">
                    <i class="fas fa-trash"></i> Sil
                </button>
            </div>
        `;
        moduleList.appendChild(card);
    });
}

// Modal göster
function showCreateModule() {
    document.getElementById('create-module-modal').style.display = 'block';
}

// Modal kapat
function closeModuleModal() {
    document.getElementById('create-module-modal').style.display = 'none';
    document.getElementById('createModuleForm').reset();
    resetFields();
}

// Sabitleme fonksiyonu
async function togglePin(moduleId, event) {
    event.stopPropagation(); // Kart tıklamasını engelle
    
    try {
        const response = await fetch(`/api/playground/modules/${moduleId}/toggle-pin`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            // Görsel güncelleme
            const pinElement = event.target.closest('.module-pin');
            if (result.is_pinned) {
                pinElement.classList.add('is-pinned');
                pinElement.title = 'Menüden kaldır';
            } else {
                pinElement.classList.remove('is-pinned');
                pinElement.title = 'Menüye sabitle';
            }
            
            // Modül listesini yeniden yükle
            await loadModules();
        }
    } catch (error) {
        console.error('Sabitleme hatası:', error);
        alert('Sabitleme hatası!');
    }
}

// Alan ekle
function addField() {
    fieldCounter++;
    const fieldList = document.getElementById('fieldList');
    const fieldItem = document.createElement('div');
    fieldItem.className = 'field-item';
    fieldItem.innerHTML = `
        <i class="fas fa-grip-vertical"></i>
        <input type="text" placeholder="Alan adı" class="field-name" required>
        <select class="field-type">
            <option value="text">Metin</option>
            <option value="number">Sayı</option>
            <option value="date">Tarih</option>
            <option value="datetime">Tarih/Saat</option>
            <option value="select">Seçim</option>
            <option value="textarea">Uzun Metin</option>
        </select>
        <input type="text" placeholder="Seçenekler (virgülle ayır)" class="field-options" style="display:none;">
        <button type="button" onclick="removeField(this)" class="btn btn-danger btn-sm">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    // Tip değiştiğinde seçenekler alanını göster/gizle
    const typeSelect = fieldItem.querySelector('.field-type');
    const optionsInput = fieldItem.querySelector('.field-options');
    typeSelect.onchange = function() {
        optionsInput.style.display = this.value === 'select' ? 'block' : 'none';
    };
    
    fieldList.appendChild(fieldItem);
}

// Alan sil
function removeField(button) {
    button.parentElement.remove();
}

// Alanları sıfırla
function resetFields() {
    const fieldList = document.getElementById('fieldList');
    fieldList.innerHTML = `
        <div class="field-item" data-field="id">
            <i class="fas fa-key"></i>
            <input type="text" value="ID" disabled>
            <select disabled>
                <option>Otomatik</option>
            </select>
            <span class="text-muted">Sistem alanı</span>
        </div>
    `;
    fieldCounter = 0;
}

// Modül düzenleme
async function editModule(moduleId) {
    const module = modules.find(m => m.id === moduleId);
    if (!module) return;
    
    // Modal'ı düzenleme moduna geçir
    document.getElementById('create-module-modal').style.display = 'block';
    document.querySelector('.modal-header h2').textContent = 'Modülü Düzenle';
    
    // Form alanlarını doldur
    document.getElementById('moduleName').value = module.name;
    document.getElementById('moduleName').readOnly = true; // İsim değiştirilemez
    document.getElementById('moduleDisplayName').value = module.display_name;
    document.getElementById('moduleIcon').value = module.icon;
    document.getElementById('moduleDescription').value = module.description || '';
    
    // Alanları yükle
    const fieldList = document.getElementById('fieldList');
    fieldList.innerHTML = `
        <div class="field-item" data-field="id">
            <i class="fas fa-key"></i>
            <input type="text" value="ID" disabled>
            <select disabled>
                <option>Otomatik</option>
            </select>
            <span class="text-muted">Sistem alanı</span>
        </div>
    `;
    
    // Mevcut alanları ekle
    module.fields.forEach(field => {
        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        fieldItem.innerHTML = `
            <i class="fas fa-grip-vertical"></i>
            <input type="text" value="${field.name}" class="field-name" required>
            <select class="field-type" value="${field.type}">
                <option value="text" ${field.type === 'text' ? 'selected' : ''}>Metin</option>
                <option value="number" ${field.type === 'number' ? 'selected' : ''}>Sayı</option>
                <option value="date" ${field.type === 'date' ? 'selected' : ''}>Tarih</option>
                <option value="datetime" ${field.type === 'datetime' ? 'selected' : ''}>Tarih/Saat</option>
                <option value="select" ${field.type === 'select' ? 'selected' : ''}>Seçim</option>
                <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Uzun Metin</option>
            </select>
            <input type="text" placeholder="Seçenekler (virgülle ayır)" class="field-options" 
                   value="${field.options ? field.options.join(', ') : ''}" 
                   style="display:${field.type === 'select' ? 'block' : 'none'};">
            <button type="button" onclick="removeField(this)" class="btn btn-danger btn-sm">
                <i class="fas fa-trash"></i>
            </button>
        `;
        fieldList.appendChild(fieldItem);
    });
    
    // Form submit'i güncelle
    document.getElementById('createModuleForm').setAttribute('data-module-id', moduleId);
}

// Modül silme
async function deleteModule(moduleId, moduleName) {
    if (!confirm(`"${moduleName}" modülünü ve tüm verilerini silmek istediğinize emin misiniz? Bu işlem geri alınamaz!`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/playground/modules/${moduleId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Modül başarıyla silindi!');
            loadModules();
        } else {
            const error = await response.json();
            alert('Hata: ' + error.error);
        }
    } catch (error) {
        alert('Silme hatası!');
    }
}

// Form submit'i güncelle
document.getElementById('createModuleForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const moduleId = this.getAttribute('data-module-id');
    const isEdit = !!moduleId;
    
    // Alanları topla
    const fields = [];
    document.querySelectorAll('.field-item:not([data-field="id"])').forEach(item => {
        const name = item.querySelector('.field-name').value;
        const type = item.querySelector('.field-type').value;
        const options = item.querySelector('.field-options').value;
        
        fields.push({
            name: name,
            type: type,
            options: options ? options.split(',').map(o => o.trim()) : null
        });
    });
    
    const moduleData = {
        name: document.getElementById('moduleName').value,
        display_name: document.getElementById('moduleDisplayName').value,
        icon: document.getElementById('moduleIcon').value,
        description: document.getElementById('moduleDescription').value,
        fields: fields
    };
    
    try {
        const url = isEdit ? `/api/playground/modules/${moduleId}` : '/api/playground/modules';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(moduleData)
        });
        
        if (response.ok || response.status === 201) {
            alert(isEdit ? 'Modül güncellendi!' : 'Modül oluşturuldu!');
            closeModuleModal();
            loadModules();
        } else {
            const error = await response.json();
            alert('Hata: ' + (error.error || 'Bilinmeyen hata'));
        }
    } catch (error) {
        console.error('Yakalanan hata:', error);  // Konsola yaz
        
        // Eğer sadece browser güvenlik hatası ise görmezden gel
        setTimeout(() => {
            loadModules();  // Listeyi yenile
        }, 100);
        
        closeModuleModal();
        // alert('Bağlantı hatası!');  // Alert'i kaldır
    }
};

// Modal kapatma güncelleme
function closeModuleModal() {
    document.getElementById('create-module-modal').style.display = 'none';
    document.getElementById('createModuleForm').reset();
    document.getElementById('createModuleForm').removeAttribute('data-module-id');
    document.getElementById('modalTitle').textContent = 'Yeni Modül Oluştur';
    document.getElementById('moduleName').readOnly = false;
    resetFields();
}
</script>
</body>
</html>